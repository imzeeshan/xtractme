{% extends 'core/base.html' %}
{% load static %}

{% block title %}Chat - {{ conversation.title|default:"New Conversation" }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message.user .message-content {
        background-color: #667eea;
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.assistant .message-content {
        background-color: white;
        color: #333;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 4px;
    }
    
    .message-role {
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 4px;
        text-transform: uppercase;
        opacity: 0.8;
    }
    
    .chat-input-container {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chat-input-form {
        display: flex;
        gap: 10px;
    }
    
    .chat-input {
        flex: 1;
        border: 1px solid #e0e0e0;
        border-radius: 24px;
        padding: 12px 20px;
        resize: none;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .send-button {
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background-color: #667eea;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .send-button:hover:not(:disabled) {
        background-color: #5568d3;
    }
    
    .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .streaming-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #667eea;
        animation: pulse 1.5s ease-in-out infinite;
        margin-left: 8px;
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
    
    pre {
        background-color: #f4f4f4;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
    }
    
    code {
        background-color: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="chat-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ conversation.title|default:"New Conversation" }}</h2>
            <a href="{% url 'chat_home' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Chats
            </a>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            {% for message in messages %}
            <div class="message {{ message.role }}">
                <div class="message-content">
                    <div class="message-role">{{ message.role|title }}</div>
                    <div class="message-text">{{ message.content|linebreaks }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="chat-input-container">
            <form id="chat-form" class="chat-input-form" onsubmit="sendMessage(event)">
                {% csrf_token %}
                <textarea 
                    name="content" 
                    id="chat-input" 
                    class="chat-input" 
                    rows="1" 
                    placeholder="Type your message here..." 
                    required
                    onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(event); }"></textarea>
                <button type="submit" class="send-button" id="send-button">
                    <i class="bi bi-send-fill"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    const conversationId = {{ conversation.id }};
    
    // Auto-scroll to bottom of chat messages
    function scrollToBottom() {
        const messagesDiv = document.getElementById('chat-messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Initial scroll
    scrollToBottom();
    
    // Send message and stream response
    function sendMessage(event) {
        event.preventDefault();
        
        const form = document.getElementById('chat-form');
        const formData = new FormData(form);
        const messageContent = formData.get('content').trim();
        
        if (!messageContent) return;
        
        // Disable form
        const sendButton = document.getElementById('send-button');
        const chatInput = document.getElementById('chat-input');
        sendButton.disabled = true;
        chatInput.disabled = true;
        
        // Add user message to UI
        addMessageToUI('user', messageContent);
        
        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';
        
        // Create assistant message placeholder
        const assistantMessageId = 'assistant-' + Date.now();
        const assistantDiv = document.createElement('div');
        assistantDiv.id = assistantMessageId;
        assistantDiv.className = 'message assistant';
        assistantDiv.innerHTML = `
            <div class="message-content">
                <div class="message-role">Assistant</div>
                <div class="message-text"></div>
                <span class="streaming-indicator"></span>
            </div>
        `;
        document.getElementById('chat-messages').appendChild(assistantDiv);
        scrollToBottom();
        
        const textDiv = assistantDiv.querySelector('.message-text');
        let fullResponse = '';
        
        // Use fetch to send message and get SSE stream
        fetch(`/chat/${conversationId}/stream/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            function readStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        // Remove streaming indicator
                        const indicator = assistantDiv.querySelector('.streaming-indicator');
                        if (indicator) indicator.remove();
                        sendButton.disabled = false;
                        chatInput.disabled = false;
                        chatInput.focus();
                        scrollToBottom();
                        return;
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                continue;
                            }
                            if (data.startsWith('Error: ')) {
                                textDiv.innerHTML = '<span style="color: red;">' + data + '</span>';
                                const indicator = assistantDiv.querySelector('.streaming-indicator');
                                if (indicator) indicator.remove();
                                sendButton.disabled = false;
                                chatInput.disabled = false;
                                continue;
                            }
                            fullResponse += data;
                            // Simple formatting
                            let formattedText = fullResponse
                                .replace(/\n/g, '<br>')
                                .replace(/`([^`]+)`/g, '<code>$1</code>')
                                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                                .replace(/\*([^*]+)\*/g, '<em>$1</em>');
                            textDiv.innerHTML = formattedText;
                            scrollToBottom();
                        }
                    }
                    
                    readStream();
                }).catch(error => {
                    console.error('Stream reading error:', error);
                    textDiv.innerHTML = '<span style="color: red;">Error reading stream. Please try again.</span>';
                    const indicator = assistantDiv.querySelector('.streaming-indicator');
                    if (indicator) indicator.remove();
                    sendButton.disabled = false;
                    chatInput.disabled = false;
                });
            }
            
            readStream();
        })
        .catch(error => {
            console.error('Error:', error);
            textDiv.innerHTML = '<span style="color: red;">Error sending message. Please try again.</span>';
            const indicator = assistantDiv.querySelector('.streaming-indicator');
            if (indicator) indicator.remove();
            sendButton.disabled = false;
            chatInput.disabled = false;
        });
    }
    
    // Add message to UI
    function addMessageToUI(role, content) {
        const messagesDiv = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + role;
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-role">${role.charAt(0).toUpperCase() + role.slice(1)}</div>
                <div class="message-text">${content.replace(/\n/g, '<br>')}</div>
            </div>
        `;
        messagesDiv.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Auto-resize textarea
    const textarea = document.getElementById('chat-input');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
</script>
{% endblock %}
